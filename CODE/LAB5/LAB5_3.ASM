DATA SEGMENT
DIVID DW 60H
MESSAGE DB 'HOW_ARE_YOU?',13,10,'$'
DATA ENDS
STACK1 SEGMENT PARA STACK
       DB 100 DUP(?)
STACK1 ENDS
CODE SEGMENT
     ASSUME CS:CODE,DS:DATA,ES:DATA,SS:STACK1
SUB1 PROC FAR
START:
	MOV AX,DATA
      	MOV DS,AX
      

      	MOV AL,80H
     	MOV DX,3FBH
      	OUT DX,AL
      	MOV AX,DIVID
      	MOV DX,3F8H
      	OUT DX,AL
      	MOV AL,AH
      	MOV DX,3F9H
      	OUT DX,AL
      	MOV AL,0BH
      	MOV DX,3F8H
      	OUT DX,AL
      	MOV AL,03H ;MODEM
      	MOV DX,3FCH
      	OUT DX,AL
      	MOV AL,0
      	MOV DX,3F9H
      	OUT DX,AL

WAIT_FOR:
      	MOV DX,3FDH
      	IN AL,DX
      	TEST AL,1EH
      	JNZ ERROR
      	TEST AL,1
      	JNZ RECEIVE
      	TEST AL,20H
      	JZ WAIT_FOR
      	MOV AH,1
      	INT 16H
      	JZ WAIT_FOR
      	MOV AH,0
      	INT 16H
      	CMP AL,'S'
	JZ  SEND
	CMP AL,'R'
	JZ  RECEIVE2
	MOV DX,3F8H
      	OUT DX,AL
      	CMP AL,20H
	JZ  QUIT
	JMP WAIT_FOR
RECEIVE:
      	MOV DX,3F8H
      	IN  AL,DX
      	AND AL,7FH
	CMP AL,7FH
	JZ  SEND
      	CMP AL,20H
      	JNZ CHAR
      	MOV AH,4CH
      	INT 21H
CHAR:
	PUSH	AX
	MOV 	AH,0EH
	INT 	10H
	POP	AX
	CMP	AL,0DH
	JNZ 	WAIT_FOR
	MOV 	AL,0AH
	MOV 	AH,0EH
	INT	10H
	JMP	WAIT_FOR
ERROR:	MOV	DX,3F8H
	IN	AL,DX
	MOV 	AL,'?'
	MOV 	AH,14
	INT 	10H
	JMP	WAIT_FOR
QUIT:	MOV 	AH,4CH
	INT 	21H

SEND:	
	MOV 	SI,0
WAIT_FOR_S:
	MOV	DX,3FDH
	IN	AL,DX
	TEST 	AL,1EH
	JNZ	ERROR
	TEST	AL,20H
	JZ 	WAIT_FOR_S
	MOV 	AL,MESSAGE[SI]
	INC 	SI
	MOV 	DX,3F8H
	OUT	DX,AL
	CMP	AL,'$'
	JNZ	WAIT_FOR_S
WAIT_FOR_RELAY:
	JMP	WAIT_FOR




RECEIVE2:
	
WAIT_FOR_SS:
	MOV 	DX,3FDH
	IN	AL,DX
	TEST	AL,1EH
	JNZ	ERROR
	TEST	AL,20H
	JZ	WAIT_FOR_SS
	MOV	AL,0FFH
	MOV	DX,3F8H
	OUT	DX,AL

WAIT_FOR_RECEIVE2:
	MOV	DX,3FDH
	IN	AL,DX
	TEST	AL,1EH
	JNZ	ERROR
	TEST	AL,1
	JZ	RECEIVE3
	JMP	WAIT_FOR_RECEIVE2
		

RECEIVE3:
	MOV	DX,3F8H
	IN	AL,DX
	AND	AL,7FH
	CMP	AL,3
	JNZ	CHAR2
CHAR2:	PUSH	AX
	MOV	AH,0EH
	INT	10H
	POP	AX
	CMP	AL,0DH
	JNZ	WAIT_FOR_RECEIVE2
	MOV	AL,0AH
	MOV	AH,0EH
	INT	10H
	CMP	AL,'$'
	JZ	WAIT_FOR_RELAY
	JMP	WAIT_FOR_RECEIVE2

SUB1	ENDP
	CODE	ENDS
	END	START
